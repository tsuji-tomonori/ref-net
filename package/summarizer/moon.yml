type: application
language: python

dependsOn:
  - shared

tasks:
  install:
    command: uv sync
    inputs:
      - "pyproject.toml"
      - "uv.lock"

  worker:
    command: celery -A refnet_summarizer.tasks.celery_app worker --loglevel=info --queue=summarize
    inputs:
      - "src/**/*.py"
    local: true

  lint:
    command: uv run ruff check src/
    inputs:
      - "src/**/*.py"

  format:
    command: uv run ruff format src/
    inputs:
      - "src/**/*.py"

  typecheck:
    command: uv run mypy src/
    inputs:
      - "src/**/*.py"

  test:
    command: uv run pytest tests/ --cov=src --cov-report=term-missing --cov-report=html
    inputs:
      - "src/**/*.py"
      - "tests/**/*.py"
    outputs:
      - "htmlcov/"

  build:
    command: docker build -t refnet-summarizer .
    inputs:
      - "src/**/*.py"
      - "Dockerfile"
    outputs:
      - "dist/"

  check:
    deps:
      - lint
      - typecheck
      - test
