# セキュリティパッチ管理手順

## パッチ適用優先度

### Critical（即座対応）
- CVEスコア 9.0 以上
- 認証バイパス脆弱性
- リモートコード実行脆弱性
- データ漏洩に直結する脆弱性

**対応期限**: 24時間以内

### High（緊急対応）
- CVEスコア 7.0-8.9
- 権限昇格脆弱性
- サービス停止につながる脆弱性

**対応期限**: 48時間以内

### Medium（計画的対応）
- CVEスコア 4.0-6.9
- 情報漏洩脆弱性
- DoS攻撃脆弱性

**対応期限**: 1週間以内

### Low（定期対応）
- CVEスコア 3.9 以下
- 軽微な情報漏洩
- 設定上の問題

**対応期限**: 1ヶ月以内

## パッチ適用手順

### 1. 脆弱性評価
1. 脆弱性スキャン結果の確認
2. CVEデータベースでの詳細確認
3. 自システムへの影響度評価
4. 優先度決定

### 2. パッチ計画
1. 修正方法の調査（バージョンアップ、設定変更等）
2. テスト計画の策定
3. ダウンタイム計画
4. ロールバック計画

### 3. テスト環境での検証
1. パッチ適用
2. 機能テストの実行
3. パフォーマンステスト
4. セキュリティテスト

### 4. 本番適用
1. 事前バックアップ
2. パッチ適用
3. 動作確認
4. 監視強化

### 5. 事後確認
1. 脆弱性修正の確認
2. システム安定性の確認
3. パッチ適用記録の更新
4. 次回定期スキャンでの確認

## 緊急パッチ適用手順

### Critical脆弱性の場合
1. **即座通知**: セキュリティチーム・管理職へ緊急連絡
2. **影響評価**: 最大30分で影響範囲を特定
3. **緊急対応**: 必要に応じてサービス停止
4. **パッチ適用**: テスト簡素化して即座適用
5. **事後検証**: 24時間以内に詳細検証

### High脆弱性の場合
1. **通知**: セキュリティチーム・開発チームへ連絡
2. **計画策定**: 24時間以内にパッチ計画策定
3. **テスト実行**: 基本テストのみ実行
4. **適用実行**: 48時間以内に本番適用
5. **監視強化**: 適用後72時間の監視強化

## 依存関係更新コマンド

### 個別パッケージ更新
```bash
# 特定パッケージの更新
cd package/[target_package]
uv add [package_name]@[version]

# セキュリティのみ更新
uv sync --upgrade-package [package_name]
```

### 全パッケージ更新
```bash
# 全体の依存関係更新
./scripts/update_dependencies.sh

# テスト実行
moon :check
```

### Docker イメージ更新
```bash
# ベースイメージ更新
docker build --no-cache -t refnet-api package/api/
docker build --no-cache -t refnet-shared package/shared/

# 脆弱性スキャン
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy image refnet-api
```

## 記録・レポート

### パッチ適用記録
- 適用日時
- 対象脆弱性（CVE番号）
- 適用方法
- ダウンタイム
- 問題・対応

### 月次レポート
- 適用済みパッチ一覧
- 未適用脆弱性一覧
- セキュリティ指標の推移
- 改善提案
