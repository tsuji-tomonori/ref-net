#!/usr/bin/env python3
"""è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³çµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ."""

import json
from datetime import datetime
from pathlib import Path
from typing import Dict, List


class VulnerabilityReporter:
    """è„†å¼±æ€§ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¯ãƒ©ã‚¹."""

    def __init__(self):
        """åˆæœŸåŒ–."""
        self.reports_dir = Path("reports")
        self.reports_dir.mkdir(exist_ok=True)

        self.severity_priority = {
            "critical": 4,
            "high": 3,
            "medium": 2,
            "low": 1
        }

    def parse_safety_report(self, filepath: Path) -> Dict:
        """Safetyã‚¹ã‚­ãƒ£ãƒ³çµæœã®è§£æ."""
        if not filepath.exists():
            return {"vulnerabilities": [], "package": filepath.stem.replace("safety-", "")}

        try:
            with open(filepath) as f:
                data = json.load(f)

            vulnerabilities = []
            for vuln in data.get("vulnerabilities", []):
                vulnerabilities.append({
                    "type": "dependency",
                    "package": vuln.get("package"),
                    "version": vuln.get("version"),
                    "severity": vuln.get("severity", "medium").lower(),
                    "description": vuln.get("advisory"),
                    "cve": vuln.get("cve"),
                    "fix_version": vuln.get("fix_versions", [])
                })

            return {
                "vulnerabilities": vulnerabilities,
                "package": filepath.stem.replace("safety-", "")
            }
        except Exception as e:
            print(f"Failed to parse Safety report {filepath}: {e}")
            return {"vulnerabilities": [], "package": filepath.stem.replace("safety-", "")}

    def parse_bandit_report(self, filepath: Path) -> Dict:
        """Banditã‚¹ã‚­ãƒ£ãƒ³çµæœã®è§£æ."""
        if not filepath.exists():
            return {"vulnerabilities": [], "package": filepath.stem.replace("bandit-", "")}

        try:
            with open(filepath) as f:
                data = json.load(f)

            vulnerabilities = []
            for result in data.get("results", []):
                vulnerabilities.append({
                    "type": "code",
                    "file": result.get("filename"),
                    "line": result.get("line_number"),
                    "severity": result.get("issue_severity", "medium").lower(),
                    "description": result.get("issue_text"),
                    "test_id": result.get("test_id"),
                    "confidence": result.get("issue_confidence")
                })

            return {
                "vulnerabilities": vulnerabilities,
                "package": filepath.stem.replace("bandit-", "")
            }
        except Exception as e:
            print(f"Failed to parse Bandit report {filepath}: {e}")
            return {"vulnerabilities": [], "package": filepath.stem.replace("bandit-", "")}

    def generate_summary_report(self, all_results: List[Dict]) -> str:
        """ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ."""
        total_vulns = sum(len(result["vulnerabilities"]) for result in all_results)

        severity_counts = {"critical": 0, "high": 0, "medium": 0, "low": 0}

        for result in all_results:
            for vuln in result["vulnerabilities"]:
                severity = vuln.get("severity", "low")
                if severity in severity_counts:
                    severity_counts[severity] += 1

        # ç·Šæ€¥åº¦åˆ¤å®š
        urgency = "ğŸŸ¢ LOW"
        if severity_counts["critical"] > 0:
            urgency = "ğŸ”´ CRITICAL"
        elif severity_counts["high"] > 0:
            urgency = "ğŸŸ  HIGH"
        elif severity_counts["medium"] > 5:
            urgency = "ğŸŸ¡ MEDIUM"

        report = f"""# è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚µãƒãƒªãƒ¼

**å®Ÿè¡Œæ—¥æ™‚**: {datetime.now().isoformat()}
**ç·Šæ€¥åº¦**: {urgency}
**ç·è„†å¼±æ€§æ•°**: {total_vulns}

## æ·±åˆ»åº¦åˆ¥é›†è¨ˆ
- ğŸ”´ Critical: {severity_counts['critical']}
- ğŸŸ  High: {severity_counts['high']}
- ğŸŸ¡ Medium: {severity_counts['medium']}
- ğŸŸ¢ Low: {severity_counts['low']}

## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆ¥è©³ç´°
"""

        for result in all_results:
            package = result["package"]
            vulns = result["vulnerabilities"]
            report += f"\n### {package}\n"

            if not vulns:
                report += "âœ… è„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\n"
                continue

            # æ·±åˆ»åº¦é †ã«ã‚½ãƒ¼ãƒˆ
            vulns_sorted = sorted(vulns,
                                key=lambda x: self.severity_priority.get(x.get("severity", "low"), 0),
                                reverse=True)

            for vuln in vulns_sorted[:5]:  # ä¸Šä½5ä»¶ã®ã¿è¡¨ç¤º
                severity_icon = {"critical": "ğŸ”´", "high": "ğŸŸ ", "medium": "ğŸŸ¡", "low": "ğŸŸ¢"}.get(vuln.get("severity", "low"), "ğŸŸ¢")
                report += f"- {severity_icon} **{vuln.get('package', vuln.get('file', 'Unknown'))}**: {vuln.get('description', 'No description')[:100]}...\n"

            if len(vulns) > 5:
                report += f"- ... ãã®ä»– {len(vulns) - 5} ä»¶\n"

        report += f"""
## æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
"""

        if severity_counts["critical"] > 0:
            report += "âš ï¸ **å³åº§å¯¾å¿œ**: Criticalè„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã¾ã™ã€‚ç·Šæ€¥ãƒ‘ãƒƒãƒé©ç”¨ãŒå¿…è¦ã§ã™ã€‚\n"

        if severity_counts["high"] > 0:
            report += "âš ï¸ **48æ™‚é–“ä»¥å†…**: Highè„†å¼±æ€§ã¸ã®å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚\n"

        if severity_counts["medium"] > 5:
            report += "ğŸ“‹ **1é€±é–“ä»¥å†…**: Mediumè„†å¼±æ€§ãŒå¤šæ•°æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã™ã€‚å„ªå…ˆé †ä½ã‚’ä»˜ã‘ã¦å¯¾å¿œã—ã¦ãã ã•ã„ã€‚\n"

        if total_vulns == 0:
            report += "âœ… è„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ç¾åœ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ…‹ã¯è‰¯å¥½ã§ã™ã€‚\n"

        return report

    def generate_detailed_report(self, all_results: List[Dict]) -> str:
        """è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ."""
        report = f"""# è„†å¼±æ€§è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ
å®Ÿè¡Œæ—¥æ™‚: {datetime.now().isoformat()}

"""

        for result in all_results:
            package = result["package"]
            vulns = result["vulnerabilities"]

            report += f"## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸: {package}\n\n"

            if not vulns:
                report += "è„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\n\n"
                continue

            for i, vuln in enumerate(vulns, 1):
                report += f"### è„†å¼±æ€§ #{i}\n"
                report += f"- **ã‚¿ã‚¤ãƒ—**: {vuln.get('type', 'unknown')}\n"
                report += f"- **æ·±åˆ»åº¦**: {vuln.get('severity', 'unknown')}\n"

                if vuln.get("package"):
                    report += f"- **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**: {vuln['package']} {vuln.get('version', '')}\n"
                if vuln.get("file"):
                    report += f"- **ãƒ•ã‚¡ã‚¤ãƒ«**: {vuln['file']}:{vuln.get('line', '')}\n"
                if vuln.get("cve"):
                    report += f"- **CVE**: {vuln['cve']}\n"

                report += f"- **èª¬æ˜**: {vuln.get('description', 'No description')}\n"

                if vuln.get("fix_version"):
                    report += f"- **ä¿®æ­£ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: {', '.join(vuln['fix_version'])}\n"

                report += "\n"

        return report

    def run(self):
        """ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Ÿè¡Œ."""
        print("Starting vulnerability report generation")

        packages = ["shared", "api", "crawler", "summarizer", "generator"]
        all_results = []

        # Safetyãƒ¬ãƒãƒ¼ãƒˆè§£æ
        for package in packages:
            safety_file = self.reports_dir / f"safety-{package}.json"
            result = self.parse_safety_report(safety_file)
            if result["vulnerabilities"]:
                all_results.append(result)

        # Banditãƒ¬ãƒãƒ¼ãƒˆè§£æ
        for package in packages:
            bandit_file = self.reports_dir / f"bandit-{package}.json"
            result = self.parse_bandit_report(bandit_file)
            if result["vulnerabilities"]:
                all_results.append(result)

        # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        summary = self.generate_summary_report(all_results)
        detailed = self.generate_detailed_report(all_results)

        # ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
        with open(self.reports_dir / "vulnerability_summary.md", "w") as f:
            f.write(summary)

        with open(self.reports_dir / "vulnerability_detailed.md", "w") as f:
            f.write(detailed)

        # JSONå‡ºåŠ›
        json_report = {
            "timestamp": datetime.now().isoformat(),
            "total_vulnerabilities": sum(len(result["vulnerabilities"]) for result in all_results),
            "results": all_results
        }

        with open(self.reports_dir / "vulnerability_report.json", "w") as f:
            json.dump(json_report, f, indent=2)

        print("Vulnerability report generation completed")
        print(summary)


def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†."""
    reporter = VulnerabilityReporter()
    reporter.run()


if __name__ == "__main__":
    main()
